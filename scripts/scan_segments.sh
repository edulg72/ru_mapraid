#!/bin/bash

cd /home/rails/megamapraid/scripts/

echo "Start: $(date '+%d/%m/%Y %H:%M:%S')"

    ruby scan_segments.rb $1 $2 17.44 54.85 18.52 54.76 0.09
    ruby scan_segments.rb $1 $2 16.99 54.76 18.79 54.67 0.09
    ruby scan_segments.rb $1 $2 16.72 54.67 18.61 54.58 0.09
    ruby scan_segments.rb $1 $2 18.7 54.67 18.88 54.58 0.09
    ruby scan_segments.rb $1 $2 16.36 54.58 18.61 54.49 0.09
    ruby scan_segments.rb $1 $2 16.27 54.49 18.79 54.4 0.09
    ruby scan_segments.rb $1 $2 19.42 54.49 20.32 54.4 0.09
    ruby scan_segments.rb $1 $2 22.75 54.49 22.93 54.4 0.09
    ruby scan_segments.rb $1 $2 16.18 54.4 23.11 54.31 0.09
    ruby scan_segments.rb $1 $2 15.73 54.31 23.38 54.22 0.09
    ruby scan_segments.rb $1 $2 15.19 54.22 23.56 54.13 0.09
    ruby scan_segments.rb $1 $2 14.74 54.13 23.56 54.04 0.09
    ruby scan_segments.rb $1 $2 14.47 54.04 23.56 53.95 0.09
    ruby scan_segments.rb $1 $2 14.11 53.95 23.56 53.86 0.09
    ruby scan_segments.rb $1 $2 14.2 53.86 23.65 53.77 0.09
    ruby scan_segments.rb $1 $2 14.2 53.77 23.65 53.68 0.09
    ruby scan_segments.rb $1 $2 14.2 53.68 23.74 53.59 0.09
    ruby scan_segments.rb $1 $2 14.29 53.59 23.74 53.5 0.09
    ruby scan_segments.rb $1 $2 14.29 53.5 23.74 53.41 0.09
    ruby scan_segments.rb $1 $2 14.29 53.41 23.83 53.32 0.09
    ruby scan_segments.rb $1 $2 14.38 53.32 23.92 53.23 0.09
    ruby scan_segments.rb $1 $2 14.29 53.23 24.01 53.14 0.09
    ruby scan_segments.rb $1 $2 14.29 53.14 23.92 53.05 0.09
    ruby scan_segments.rb $1 $2 14.11 53.05 24.01 52.96 0.09
    ruby scan_segments.rb $1 $2 14.11 52.96 24.01 52.87 0.09
    ruby scan_segments.rb $1 $2 14.11 52.87 24.01 52.78 0.09
    ruby scan_segments.rb $1 $2 14.2 52.78 24.01 52.69 0.09
    ruby scan_segments.rb $1 $2 14.38 52.69 24.01 52.6 0.09
    ruby scan_segments.rb $1 $2 14.56 52.6 23.65 52.51 0.09
    ruby scan_segments.rb $1 $2 14.47 52.51 23.47 52.42 0.09
    ruby scan_segments.rb $1 $2 14.47 52.42 23.38 52.33 0.09
    ruby scan_segments.rb $1 $2 14.56 52.33 23.29 52.24 0.09
    ruby scan_segments.rb $1 $2 14.65 52.24 23.56 52.15 0.09
    ruby scan_segments.rb $1 $2 14.65 52.15 23.74 52.06 0.09
    ruby scan_segments.rb $1 $2 14.65 52.06 23.74 51.97 0.09
    ruby scan_segments.rb $1 $2 14.65 51.97 23.65 51.88 0.09
    ruby scan_segments.rb $1 $2 14.56 51.88 23.74 51.79 0.09
    ruby scan_segments.rb $1 $2 14.56 51.79 23.65 51.7 0.09
    ruby scan_segments.rb $1 $2 14.65 51.7 23.65 51.61 0.09
    ruby scan_segments.rb $1 $2 14.65 51.61 23.65 51.52 0.09
    ruby scan_segments.rb $1 $2 14.74 51.52 23.74 51.43 0.09
    ruby scan_segments.rb $1 $2 14.92 51.43 23.74 51.34 0.09
    ruby scan_segments.rb $1 $2 14.92 51.34 23.74 51.25 0.09
    ruby scan_segments.rb $1 $2 14.92 51.25 23.92 51.16 0.09
    ruby scan_segments.rb $1 $2 14.92 51.16 23.92 51.07 0.09
    ruby scan_segments.rb $1 $2 14.83 51.07 24.01 50.98 0.09
    ruby scan_segments.rb $1 $2 14.74 50.98 15.1 50.89 0.09
    ruby scan_segments.rb $1 $2 15.19 50.98 24.1 50.89 0.09
    ruby scan_segments.rb $1 $2 14.74 50.89 15.01 50.8 0.09
    ruby scan_segments.rb $1 $2 15.28 50.8 24.1 50.71 0.09
    ruby scan_segments.rb $1 $2 15.91 50.62 16.09 50.53 0.09
    ruby scan_segments.rb $1 $2 16.18 50.53 24.1 50.44 0.09
    ruby scan_segments.rb $1 $2 16.18 50.44 24.1 50.35 0.09
    ruby scan_segments.rb $1 $2 16.36 50.35 17.08 50.26 0.09
    ruby scan_segments.rb $1 $2 17.17 50.35 23.74 50.26 0.09
    ruby scan_segments.rb $1 $2 16.45 50.26 17.08 50.17 0.09
    ruby scan_segments.rb $1 $2 17.35 50.26 17.53 50.17 0.09
    ruby scan_segments.rb $1 $2 17.62 50.26 23.65 50.17 0.09
    ruby scan_segments.rb $1 $2 16.54 50.17 16.81 50.08 0.09
    ruby scan_segments.rb $1 $2 17.53 50.17 23.47 50.08 0.09
    ruby scan_segments.rb $1 $2 17.71 50.08 23.29 49.99 0.09
    ruby scan_segments.rb $1 $2 17.8 49.99 17.98 49.9 0.09
    ruby scan_segments.rb $1 $2 18.07 49.99 23.2 49.9 0.09
    ruby scan_segments.rb $1 $2 18.52 49.9 23.11 49.81 0.09
    ruby scan_segments.rb $1 $2 18.52 49.81 23.02 49.72 0.09
    ruby scan_segments.rb $1 $2 18.61 49.72 22.93 49.63 0.09
    ruby scan_segments.rb $1 $2 18.79 49.63 22.84 49.54 0.09
    ruby scan_segments.rb $1 $2 18.79 49.54 19.42 49.45 0.09
    ruby scan_segments.rb $1 $2 19.51 49.54 22.75 49.45 0.09
    ruby scan_segments.rb $1 $2 18.97 49.45 19.24 49.36 0.09
    ruby scan_segments.rb $1 $2 19.6 49.45 22.84 49.36 0.09
    ruby scan_segments.rb $1 $2 19.78 49.36 20.41 49.27 0.09
    ruby scan_segments.rb $1 $2 20.77 49.36 21.04 49.27 0.09
    ruby scan_segments.rb $1 $2 21.76 49.36 22.84 49.27 0.09
    ruby scan_segments.rb $1 $2 19.69 49.27 20.14 49.18 0.09
    ruby scan_segments.rb $1 $2 22.03 49.27 22.84 49.18 0.09
    ruby scan_segments.rb $1 $2 20.05 49.18 20.14 49.09 0.09
    ruby scan_segments.rb $1 $2 22.12 49.18 22.93 49.09 0.09
    ruby scan_segments.rb $1 $2 22.48 49.09 22.93 49.0 0.09

psql -h $POSTGRESQL_DB_HOST -d wazeru -U waze -c 'update segments set city_id = (select gid from cities_mapraid where ST_Contains(geom, ST_SetSRID(ST_Point(segments.longitude, segments.latitude), 4326)) limit 1) where city_id is null;'
psql -h $POSTGRESQL_DB_HOST -d wazeru -U waze -c 'delete from segments where city_id is null;'
psql -h $POSTGRESQL_DB_HOST -d wazeru -U waze -c 'update segments set area_id = (select id from areas_mapraid where ST_Contains(geom, ST_SetSRID(ST_Point(segments.longitude, segments.latitude), 4326)) and id > 100 limit 1) where area_id is null'
psql -h $POSTGRESQL_DB_HOST -d wazeru -U waze -c 'delete from streets where id in (select id from streets except select distinct street_id from segments);'
psql -h $POSTGRESQL_DB_HOST -d wazeru -U waze -c 'update segments s1 set dc_density = (select count(*) from segments s2 where not s2.connected and s2.latitude between (s1.latitude - 0.01) and (s1.latitude + 0.01) and s2.longitude between (s1.longitude - 0.01) and (s1.longitude + 0.01)) where not s1.connected and s1.dc_density is null;'
psql -h $POSTGRESQL_DB_HOST -d wazeru -U waze -c "update updates set updated_at = current_timestamp where object = 'segments';"
psql -h $POSTGRESQL_DB_HOST -d wazeru -U waze -c "refresh materialized view vw_segments; refresh materialized view vw_streets;"
psql -h $POSTGRESQL_DB_HOST -d wazeru -U waze -c 'vacuum analyze;'

echo "End: $(date '+%d/%m/%Y %H:%M:%S')"
